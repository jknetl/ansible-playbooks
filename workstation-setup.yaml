- name: Setup user utilities
  hosts: workstations
  tasks:
    - name: Install packages
      become: true
      block:
      - name: Perform an upgrade
        community.general.pacman:
          upgrade: true
          update_cache: true
      - name: Install basic system packages
        community.general.pacman:
          name:
            - vim
            - zsh
            - yay
            - neovim
            - konsole
          state: present
      - name: Create the `aur_builder` user
        ansible.builtin.user:
          name: aur_builder
          create_home: yes
          group: wheel

      - name: Allow the `aur_builder` user to run `sudo pacman` without a password
        ansible.builtin.lineinfile:
          path: /etc/sudoers.d/11-install-aur_builder
          line: 'aur_builder ALL=(ALL) NOPASSWD: /usr/bin/pacman'
          create: yes
          mode: 0644
          validate: 'visudo -cf %s'
    - name: Upgrade AUR packages
      kewlfft.aur.aur:
        upgrade: yes
        use: yay
        aur_only: yes
      become: yes
      become_user: aur_builder
    - name: Install AUR packages
      kewlfft.aur.aur:
        name: visual-studio-code-bin
        use: makepkg
        state: present
      become: yes
      become_user: aur_builder
          